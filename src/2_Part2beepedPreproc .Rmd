#Load necessary packages
```{r}
library(dplyr)
library(lubridate)
library(janitor)
```

#Import data from CO-video coding procedure (Documentation forthcoming)
```{r}
video_data_path <- "C:/Users/Walt/OneDrive - The Pennsylvania State University/Projects/ASH/DVAL/4. Derivative data/CO-video-data/DVAL_CO-video_data_part2.csv"

video_data_part2 <- read.csv(video_data_path)
```
#Clean names
```{r}
video_data_part2_1 <-clean_names(video_data_part2)
```

#Assign correct variable types and create datetime variables
```{r}
video_data_part2_1 <- video_data_part2_1 %>%
  # Convert *_date columns to Date
  mutate(across(contains("_date"), ~ mdy(na_if(., "")))) %>%

  # Convert *_time_recorded columns to hms only if they match HH:MM(:SS) pattern
  mutate(across(contains("_time_recorded"), ~ {
    cleaned <- na_if(., "")
    cleaned[!grepl("^\\d{1,2}:\\d{2}(:\\d{2})?$", cleaned)] <- NA
    hms(cleaned)
  })) %>%

  # Convert *_co_level columns to numeric
  mutate(across(contains("_co_level"), ~ as.numeric(ifelse(grepl("^[0-9.]+$", .), ., NA)))) %>%

  # Convert *_state_smoked columns to 1/0/NA
  mutate(across(contains("_state_smoked"), ~ case_when(
    tolower(.) == "yes" ~ 1,
    tolower(.) == "no" ~ 0,
    tolower(.) %in% c("dnr", "") | is.na(.) ~ NA_real_,
    TRUE ~ NA_real_
  ))) %>%

  # Ensure 'notes' is character
  mutate(notes = as.character(notes))
```


```{r}
```



#Import EMA data from "Part 2" of the study.
```{r}
part2beeped <- read.csv("/Users/Walt/OneDrive - The Pennsylvania State University/Projects/ASH/DVAL/4. Derivative data/Smartphone/Organize_EMA_data/DVAL_EMA_Part2_beeped.csv", 
                        na = c("-99", "__NA__"), stringsAsFactors = FALSE)
```
#Removal of variables with 100% missing data due to how the survey was programmed (Refer to DREAM manual.pdf for explanation): Milestone_3 - Milestone_10; Milestone_3_time - Milestone_10_time.
```{r}
part2beeped <- part2beeped[ , !(names(part2beeped) %in% 
  c(paste0("Milestone_", 3:10), paste0("Milestone_", 3:10, "_time")))]
```

#Reformatting. Because there is a risk of losing data during reformatting, I have included chunks of code throughout this section to check for missingness. Early on, discrepancies were identified. By the end, all cases were accounted for (vs. lost without a reason).
```{r}
#Pre-reformatting actions
#Create object to represent all time variables to have on hand for subsequent fidelity checks (i.e., I wanted to check the missingness for these variables before and after reformatting, and this was a handy way to set things up.)
date_time_vars <- c(
  "init_time", "completion_time", "submission_time", "happy_time", "dissatisfied_time", 
  "irritable_time", "relaxed_time", "depressed_time", "mentally_exhausted_time", 
  "elated_time", "stressed_time", "difficulty_concentrating_time", "health_time", 
  "mood_time", "energy_level_time", "smoke_time", "motivated_time", "confident_time", 
  "pay_time", "easy_difficult_time", "before_survey_time", "pleasant_time", "neutral_time", 
  "unpleasant_time", "prior_mood_time", "pleasurable_activities_time", 
  "stressful_occurrence_time", "how_stressful_time", "location_time", 
  "current_location_time", "who_been_with_time", "smoking_now_time", 
  "physically_active_time", "smoked_since_last_survey_time", "consumed_time", 
  "upcoming_activities_time", "time_start", "time_complete", "time_submit", "Milestone_1_time", "Milestone_2_time"
)

#Create object to check missingness before reformatting.
date_time_counts_before <- colSums(!is.na(part2beeped[date_time_vars]))
```

```{r}
#Code to investigate an issue that was discovered in the following steps involving an increase in missingness for the variables 'completion_time', 'time_complete', 'date_complete'. After circling back and adding this chunk of code to investigate, the cause was determined: the text 'NA' in 162 cells was recognized as non-missing, even though it was meant to represent missing data.
#Check for empty strings, literal "NA" strings, and actual NAs for 'completion_time'
table(part2beeped$completion_time == "")           # empty strings
table(part2beeped$completion_time == "NA")         # literal "NA" strings
table(is.na(part2beeped$completion_time))          # actual NAs
#Check for empty strings, literal "NA" strings, and actual NAs for `time_complete`
cat("----- time_complete -----\n")
print(table(part2beeped$time_complete == ""))       # empty strings
print(table(part2beeped$time_complete == "NA"))     # literal "NA" strings
print(table(is.na(part2beeped$time_complete)))      # actual NAs
#Check for empty strings, literal "NA" strings, and actual NAs for `date_complete`
cat("----- date_complete -----\n")
print(table(part2beeped$date_complete == ""))       # empty strings
print(table(part2beeped$date_complete == "NA"))     # literal "NA" strings
print(table(is.na(part2beeped$date_complete)))      # actual NAs
```

```{r}
#Date & time variables are assigned 'POSIXct' format
part2beeped = part2beeped %>%
    mutate(across(c(init_time, completion_time, submission_time, happy_time, dissatisfied_time, 
                    irritable_time, relaxed_time, depressed_time, mentally_exhausted_time, 
                    elated_time, stressed_time, difficulty_concentrating_time, health_time, 
                    mood_time, energy_level_time, smoke_time, motivated_time, confident_time, 
                    pay_time, easy_difficult_time, before_survey_time, pleasant_time, neutral_time, 
                    unpleasant_time, prior_mood_time, pleasurable_activities_time, 
                    stressful_occurrence_time, how_stressful_time, location_time, 
                    current_location_time, who_been_with_time, smoking_now_time, 
                    physically_active_time, smoked_since_last_survey_time, consumed_time, 
                    upcoming_activities_time, Milestone_1_time, Milestone_2_time), 
                  ~ as.POSIXct(., tz="America/New_York", format="%Y-%m-%d %H:%M:%OS")))
#Time variables reformatted to POSIXct separately from the above variables (Note: I needed to add a default date in order to use POSIXct format. Below, the date 1970-01-01 was used as is common in these cases).
part2beeped = part2beeped %>%
    mutate(across(c(time_start, time_complete, time_submit), 
                  ~ as.POSIXct(paste("1970-01-01", .), tz="America/New_York", format="%Y-%m-%d %H:%M:%S")))
```

#Check fidelity of the reformatting process (note that the missingness before and after is identitcal, other than the variables 'completion_time' and 'time_complete', where missingness increased. It was determined that this was due to 162 cells with the text 'NA' being recognized as actual data. After the reformatting action, these 'NA' values were converted to actual missing data, and R now recognizes them as such.)
```{r}
#Create objects to check missingness after reformatting.
date_time_counts_after <- colSums(!is.na(part2beeped[date_time_vars]))
#Create a table for before/after missingness comparison.
date_time_before_after_comparison <- data.frame(before = date_time_counts_before, after = date_time_counts_after)
print(date_time_before_after_comparison)
```


#Reformatting continued.
```{r}
#Date (only) variables
# Check non-missing count before reformatting
survey_date_before <- sum(!is.na(part2beeped$survey_date))
#Reformat survey_date
part2beeped <- part2beeped %>%
  mutate(
    survey_date = case_when(
      grepl("^\\d{2}/\\d{2}/\\d{2}$", survey_date) ~ mdy(survey_date),
      grepl("^\\d{4}-\\d{2}-\\d{2}$", survey_date) ~ as.Date(survey_date),
      TRUE ~ NA_Date_
    )
  )
#Check non-missing count after reformatting
survey_date_after <- sum(!is.na(part2beeped$survey_date))
# Create a comparison table
survey_date_missingness_comparison <- data.frame(
  before = survey_date_before,
  after = survey_date_after
)
print(survey_date_missingness_comparison)
```


```{r}
#Check non-missing counts before reformatting
date_complete_before <- sum(!is.na(part2beeped$date_complete))
date_submit_before <- sum(!is.na(part2beeped$date_submit))

#Reformat both variables to Date
part2beeped <- part2beeped %>%
  mutate(across(c(date_complete, date_submit), as.Date))
#Check non-missing counts after reformatting
date_complete_after <- sum(!is.na(part2beeped$date_complete))
date_submit_after <- sum(!is.na(part2beeped$date_submit))
#Create a comparison table
date_fields_missingness_comparison <- data.frame(
  variable = c("date_complete", "date_submit"),
  before = c(date_complete_before, date_submit_before),
  after = c(date_complete_after, date_submit_after)
)
print(date_fields_missingness_comparison)

```
#Summary of reformatting date, date/time, and time variables: missingness increased for three variables, but this was due to an issue with how 162 cells with missing data were imported. No data were lost in these steps.

#Reformatting continued (numeric variables).
```{r}
numeric_vars <- c(
  "happy", "dissatisfied", "irritable", "relaxed", "depressed", "mentally_exhausted",
  "elated", "stressed", "difficulty_concentrating", "health", "mood", "energy_level",
  "smoke", "motivated", "confident", "pay", "easy_difficult", "pleasant", "unpleasant",
  "prior_mood", "pleasurable_activities", "how_stressful", "physically_active",
  "smoked_since_last_survey"
)
```

#Check that all increases in missingness detected in the subsequent chunk of code are accounted for.
```{r}
#happy (3)
bad_vals <- part2beeped$happy[!is.na(part2beeped$happy) & part2beeped$happy != "" & part2beeped$happy != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#irritable (1)
bad_vals <- part2beeped$irritable[!is.na(part2beeped$irritable) & part2beeped$irritable != "" & part2beeped$irritable != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#relaxed (1)
bad_vals <- part2beeped$irritable[!is.na(part2beeped$relaxed) & part2beeped$relaxed != "" & part2beeped$relaxed != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#stressed (1)
bad_vals <- part2beeped$stressed[!is.na(part2beeped$stressed) & part2beeped$stressed != "" & part2beeped$stressed != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#difficulty_concentrating (1)
bad_vals <- part2beeped$difficulty_concentrating[!is.na(part2beeped$difficulty_concentrating) & part2beeped$difficulty_concentrating != "" & part2beeped$difficulty_concentrating != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#health (3)
bad_vals <- part2beeped$health[!is.na(part2beeped$health) & part2beeped$health != "" & part2beeped$health != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#mood (1)
bad_vals <- part2beeped$mood[!is.na(part2beeped$mood) & part2beeped$mood != "" & part2beeped$mood != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#confident (1)
bad_vals <- part2beeped$confident[!is.na(part2beeped$confident) & part2beeped$confident != "" & part2beeped$confident != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#pay (12)
bad_vals <- part2beeped$pay[!is.na(part2beeped$pay) & part2beeped$pay != "" & part2beeped$pay != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#pleasurable_activities (1)
bad_vals <- part2beeped$pleasurable_activities[!is.na(part2beeped$pleasurable_activities) & part2beeped$pleasurable_activities != "" & part2beeped$pleasurable_activities != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#smoked_since_last_survey (109)
bad_vals <- part2beeped$smoked_since_last_survey[!is.na(part2beeped$smoked_since_last_survey) & part2beeped$smoked_since_last_survey != "" & part2beeped$smoked_since_last_survey != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])
```

```{r}
#Create object to check missingness before reformatting.
numeric_counts_before <- colSums (!is.na (part2beeped[numeric_vars]))
#Based on the troubleshooting code above, 'smoked_since_last_survey' contains non-numeric values (i.e., '6+'). Because this variable will be treated as discrete for future analyses, it is reasonable to recode all instances of '6+' to '6'. The code below executes this function.
part2beeped$smoked_since_last_survey <- gsub("^6\\+$", "6", part2beeped$smoked_since_last_survey)
#Reformat numeric variables including a step to code all instances of 'opted out' (regardless of case) as '999'.
part2beeped <- part2beeped %>%
  mutate(across(all_of(numeric_vars), ~ case_when(
    as.character(.) %in% c("opted out", "Opted out") ~ "999",
    TRUE ~ as.character(.)
  ))) %>%
  mutate(across(all_of(numeric_vars), ~ as.numeric(.)))
#Create object to check missingness after reformatting.
numeric_counts_after <- colSums (!is.na (part2beeped[numeric_vars]))
# Create a table for before/after missingness comparison
numeric_before_after_comparison <- data.frame(
  variable = names(numeric_counts_before),
  before = numeric_counts_before,
  after = numeric_counts_after
)
print(numeric_before_after_comparison)
```

#Summary of reformatting numeric variables: all introduced missingness is accounted for. Instances where participants 'opted out' were recoded as '999'. For 'smoked_since_last_survey', all cases of '6+' were recoded as '6'. These recoding steps allowed for the effective reformatting of numeric variables from character to numeric.

#Run the 'clean_names' function in the janitor package, so that variable names with hyphens become variable names with underscores and all text in variable names becomes lowercase (e.g., 'Milestone_1' -> 'milestone_1').
```{r}
part2beeped_1 <- clean_names(part2beeped)
```

#First Glimpse for EMA data - included in this RMD as for a "quick and efficient overview of the dataset." The code is not "chunked" because it takes a long time to run and is optional.

#View structure of data (Examine variable types and dataset dimensions)
glimpse(part2beeped_1)
#View descriptive statistics (For each variable, examine % missing, mean, sd, frequencies by quartile, and histogram)
skim(part2beeped_1)

#Temporary until git established; Save as csv.
```{r}
saveRDS(part2beeped_1, "C:\\Users\\Walt\\OneDrive - The Pennsylvania State University\\Projects\\ASH\\DVAL\\Users\\Walter\\Preprocessing\\Interim Data\\part2beeped_1.rds")

```

