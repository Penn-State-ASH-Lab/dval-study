---
title: "3_Part6Beeped Preprocessing"
author: "DVAL Lab"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
# Load required packages
library(here)
library(dplyr)
library(lubridate)
library(janitor)
library(skimr)

# Define path to EMA Part 6 data
part6_path <- here("data", "DVAL_EMA_part6_beeped.csv")
```

# Import EMA data from Part 6
```{r}
part6beeped <- read.csv(
  part6_path, 
  na.strings = c("-99", "__NA__"), 
  stringsAsFactors = FALSE
)
```


#Removal of variables with 100% missing data due to how the survey was programmed (Refer to DREAM manual.pdf for explanation): Milestone_3 - Milestone_10; Milestone_3_time - Milestone_10_time.
```{r}
part6beeped <- part6beeped[ , !(names(part6beeped) %in% 
  c(paste0("Milestone_", 3:10), paste0("Milestone_", 3:10, "_time")))]
```
#Reformatting. Because there is a risk of losing data during reformatting, I have included chunks of code throughout this section to check for missingness. Early on, discrepancies were identified. By the end, all cases were accounted for (vs. lost without a reason).
```{r}
#Pre-reformatting actions
#Create object to represent all time variables to have on hand for subsequent fidelity checks (i.e., I wanted to check the missingness for these variables before and after reformatting, and this was a handy way to set things up.)
date_time_vars <- c(
  "init_time", "completion_time", "submission_time", "happy_time", "dissatisfied_time", 
  "irritable_time", "relaxed_time", "depressed_time", "mentally_exhausted_time", 
  "elated_time", "stressed_time", "difficulty_concentrating_time", "health_time", 
  "mood_time", "energy_level_time", "smoke_time", "motivated_time", "confident_time", 
  "pay_time", "easy_difficult_time", "before_survey_time", "pleasant_time", "neutral_time", 
  "unpleasant_time", "prior_mood_time", "pleasurable_activities_time", 
  "stressful_occurrence_time", "how_stressful_time", "location_time", 
  "current_location_time", "who_been_with_time", "smoking_now_time", 
  "physically_active_time", "smoked_since_last_survey_time", "consumed_time", 
  "upcoming_activities_time", "time_start", "time_complete", "time_submit", "Milestone_1_time", "Milestone_2_time"
)
#Create object to check missingness before reformatting.
date_time_counts_before <- colSums(!is.na(part6beeped[date_time_vars]))
```

```{r}
#Code to investigate an issue that was discovered in the following steps involving an increase in missingness for the variables 'completion_time', 'time_complete', 'date_complete'. After circling back and adding this chunk of code to investigate, the cause was determined: the text 'NA' in 209 cells was recognized as non-missing, even though it was meant to represent missing data.
#Check for empty strings, literal "NA" strings, and actual NAs for 'completion_time'
table(part6beeped$completion_time == "")           # empty strings
table(part6beeped$completion_time == "NA")         # literal "NA" strings
table(is.na(part6beeped$completion_time))          # actual NAs
#Check for empty strings, literal "NA" strings, and actual NAs for `time_complete`
cat("----- time_complete -----\n")
print(table(part6beeped$time_complete == ""))       # empty strings
print(table(part6beeped$time_complete == "NA"))     # literal "NA" strings
print(table(is.na(part6beeped$time_complete)))      # actual NAs
#Check for empty strings, literal "NA" strings, and actual NAs for `date_complete`
cat("----- date_complete -----\n")
print(table(part6beeped$date_complete == ""))       # empty strings
print(table(part6beeped$date_complete == "NA"))     # literal "NA" strings
print(table(is.na(part6beeped$date_complete)))      # actual NAs
```

```{r}
#Date & time variables are assigned 'POSIXct' format
part6beeped = part6beeped %>%
    mutate(across(c(init_time, completion_time, submission_time, happy_time, dissatisfied_time, 
                    irritable_time, relaxed_time, depressed_time, mentally_exhausted_time, 
                    elated_time, stressed_time, difficulty_concentrating_time, health_time, 
                    mood_time, energy_level_time, smoke_time, motivated_time, confident_time, 
                    pay_time, easy_difficult_time, before_survey_time, pleasant_time, neutral_time, 
                    unpleasant_time, prior_mood_time, pleasurable_activities_time, 
                    stressful_occurrence_time, how_stressful_time, location_time, 
                    current_location_time, who_been_with_time, smoking_now_time, 
                    physically_active_time, smoked_since_last_survey_time, consumed_time, 
                    upcoming_activities_time, Milestone_1_time, Milestone_2_time), 
                  ~ as.POSIXct(., tz="America/New_York", format="%Y-%m-%d %H:%M:%OS")))
#Time variables reformatted to POSIXct separately from the above variables (Note: I needed to add a default date in order to use POSIXct format. Below, the date 1970-01-01 was used as is common in these cases).
part6beeped = part6beeped %>%
    mutate(across(c(time_start, time_complete, time_submit), 
                  ~ as.POSIXct(paste("1970-01-01", .), tz="America/New_York", format="%Y-%m-%d %H:%M:%S")))
```

#Check fidelity of the reformatting process (note that the missingness before and after is identitcal, other than the variables 'completion_time' and 'time_complete', where missingness increased. It was determined that this was due to 162 cells with the text 'NA' being recognized as actual data. After the reformatting action, these 'NA' values were converted to actual missing data, and R now recognizes them as such.)
```{r}
#Create objects to check missingness after reformatting.
date_time_counts_after <- colSums(!is.na(part6beeped[date_time_vars]))
#Create a table for before/after missingness comparison.
date_time_before_after_comparison <- data.frame(before = date_time_counts_before, after = date_time_counts_after)
print(date_time_before_after_comparison)
```


#Reformatting continued.
```{r}
#Date (only) variables
# Check non-missing count before reformatting
survey_date_before <- sum(!is.na(part6beeped$survey_date))
#Reformat survey_date
part6beeped <- part6beeped %>%
  mutate(
    survey_date = case_when(
      grepl("^\\d{2}/\\d{2}/\\d{2}$", survey_date) ~ mdy(survey_date),
      grepl("^\\d{4}-\\d{2}-\\d{2}$", survey_date) ~ as.Date(survey_date),
      TRUE ~ NA_Date_
    )
  )
#Check non-missing count after reformatting
survey_date_after <- sum(!is.na(part6beeped$survey_date))
# Create a comparison table
survey_date_missingness_comparison <- data.frame(
  before = survey_date_before,
  after = survey_date_after
)
print(survey_date_missingness_comparison)
```


```{r}
#Check non-missing counts before reformatting
date_complete_before <- sum(!is.na(part6beeped$date_complete))
date_submit_before <- sum(!is.na(part6beeped$date_submit))

#Reformat both variables to Date
part6beeped <- part6beeped %>%
  mutate(across(c(date_complete, date_submit), as.Date))
#Check non-missing counts after reformatting
date_complete_after <- sum(!is.na(part6beeped$date_complete))
date_submit_after <- sum(!is.na(part6beeped$date_submit))
#Create a comparison table
date_fields_missingness_comparison <- data.frame(
  variable = c("date_complete", "date_submit"),
  before = c(date_complete_before, date_submit_before),
  after = c(date_complete_after, date_submit_after)
)
print(date_fields_missingness_comparison)

```
#Summary of reformatting date, date/time, and time variables: missingness increased for three variables, but this was due to an issue with how 162 cells with missing data were imported. No data were lost in these steps.

#Reformatting continued (numeric variables).
```{r}
numeric_vars <- c(
  "happy", "dissatisfied", "irritable", "relaxed", "depressed", "mentally_exhausted",
  "elated", "stressed", "difficulty_concentrating", "health", "mood", "energy_level",
  "smoke", "motivated", "confident", "pay", "easy_difficult", "pleasant", "unpleasant",
  "prior_mood", "pleasurable_activities", "how_stressful", "physically_active",
  "smoked_since_last_survey"
)
#Check that all increases in missingness detected in the subsequent chunk of code are accounted for. Headings for each chunk have the number of increased missingness detected for each variable.

#happy (2)
bad_vals <- part6beeped$happy[!is.na(part6beeped$happy) & part6beeped$happy != "" & part6beeped$happy != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#dissatisfied (2)
bad_vals <- part6beeped$dissatisfied[!is.na(part6beeped$dissatisfied) & part6beeped$dissatisfied != "" & part6beeped$dissatisfied != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#irritable (2)
bad_vals <- part6beeped$irritable[!is.na(part6beeped$irritable) & part6beeped$irritable != "" & part6beeped$irritable != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#relaxed (1)
bad_vals <- part6beeped$relaxed[!is.na(part6beeped$relaxed) & part6beeped$relaxed != "" & part6beeped$relaxed != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#depressed (4)
bad_vals <- part6beeped$depressed[!is.na(part6beeped$depressed) & part6beeped$depressed != "" & part6beeped$depressed != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#mentally_exhausted (3)
bad_vals <- part6beeped$mentally_exhausted[!is.na(part6beeped$mentally_exhausted) & part6beeped$mentally_exhausted != "" & part6beeped$mentally_exhausted != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#elated (2)
bad_vals <- part6beeped$elated[!is.na(part6beeped$elated) & part6beeped$elated != "" & part6beeped$elated != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#stressed (1)
bad_vals <- part6beeped$stressed[!is.na(part6beeped$stressed) & part6beeped$stressed != "" & part6beeped$stressed != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#difficulty_concentrating (1)
bad_vals <- part6beeped$difficulty_concentrating[!is.na(part6beeped$difficulty_concentrating) & part6beeped$difficulty_concentrating != "" & part6beeped$difficulty_concentrating != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#health (1)
bad_vals <- part6beeped$health[!is.na(part6beeped$health) & part6beeped$health != "" & part6beeped$health != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#mood (1)
bad_vals <- part6beeped$mood[!is.na(part6beeped$mood) & part6beeped$mood != "" & part6beeped$mood != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#energy_level (2)
bad_vals <- part6beeped$energy_level[!is.na(part6beeped$energy_level) & part6beeped$energy_level != "" & part6beeped$energy_level != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#smoke (1)
bad_vals <- part6beeped$smoke[!is.na(part6beeped$smoke) & part6beeped$smoke != "" & part6beeped$smoke != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#motivated (1)
bad_vals <- part6beeped$motivated[!is.na(part6beeped$motivated) & part6beeped$motivated != "" & part6beeped$motivated != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#confident (3)
bad_vals <- part6beeped$confident[!is.na(part6beeped$confident) & part6beeped$confident != "" & part6beeped$confident != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#pay (4)
bad_vals <- part6beeped$pay[!is.na(part6beeped$pay) & part6beeped$pay != "" & part6beeped$pay != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#easy_difficult (1)
bad_vals <- part6beeped$easy_difficult[!is.na(part6beeped$easy_difficult) & part6beeped$easy_difficult != "" & part6beeped$easy_difficult != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#pleasurable_activities (5)
bad_vals <- part6beeped$pleasurable_activities[!is.na(part6beeped$pleasurable_activities) & part6beeped$pleasurable_activities != "" & part6beeped$pleasurable_activities != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#physically_active (1)
bad_vals <- part6beeped$physically_active[!is.na(part6beeped$physically_active) & part6beeped$physically_active != "" & part6beeped$physically_active != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])

#smoked_since_last_survey (16)
bad_vals <- part6beeped$smoked_since_last_survey[!is.na(part6beeped$smoked_since_last_survey) & part6beeped$smoked_since_last_survey != "" & part6beeped$smoked_since_last_survey != "NA"]
print(bad_vals[is.na(as.numeric(bad_vals))])
```

```{r}
#Create object to check missingness before reformatting.
numeric_counts_before <- colSums (!is.na (part6beeped[numeric_vars]))
#Based on the troubleshooting code above, 'smoked_since_last_survey' contains non-numeric values (i.e., '6+'). Because this variable will be treated as discrete for future analyses, it is reasonable to recode all instances of '6+' to '6'. The code below executes this function.
part6beeped$smoked_since_last_survey <- gsub("^6\\+$", "6", part6beeped$smoked_since_last_survey)
#Reformat numeric variables (They were originally imported as character)
part6beeped <- part6beeped %>%
  mutate(across(all_of(numeric_vars), ~ case_when(
    as.character(.) %in% c("opted out", "Opted out") ~ "999",
    TRUE ~ as.character(.)
  ))) %>%
  mutate(across(all_of(numeric_vars), ~ as.numeric(.)))
#Create object to check missingness after reformatting.
numeric_counts_after <- colSums (!is.na (part6beeped[numeric_vars]))
# Create a table for before/after missingness comparison
numeric_before_after_comparison <- data.frame(
  variable = names(numeric_counts_before),
  before = numeric_counts_before,
  after = numeric_counts_after
)
print(numeric_before_after_comparison)
```

#Summary of reformatting numeric variables: all introduced missingness is accounted for. Instances where participants 'opted out' were recoded as '999'. For 'smoked_since_last_survey', all cases of '6+' were recoded as '6'. These recoding steps allowed for the effective reformatting of numeric variables from character to numeric.

#Run the 'clean_names' function in the janitor package, so that variable names with hyphens become variable names with underscores and all text in variable names becomes lowercase (e.g., 'Milestone_1' -> 'milestone_1').
```{r}
part6beeped_1 <- clean_names(part6beeped)
```
#Recode study_day variable to prepare for the merging of EMA datasets so that a value of 1 becomes 4, a value of 2 becomes 5, and so forth (this step is only necessary for part6beeped EMA). 
```{r}
part6beeped_1 <- part6beeped_1 %>%
  mutate(study_day = c(4, 5, 6, 7, 8, 9, 10)[study_day])
```

#First Glimpse for EMA data - included in this RMD as for a "quick and efficient overview of the dataset." The code is not "chunked" because it takes a long time to run and is optional.

#View structure of data (Examine variable types and dataset dimensions)
glimpse(part6beeped_1)
#View descriptive statistics (For each variable, examine % missing, mean, sd, frequencies by quartile, and histogram)
skim(part6beeped_1)

# Save cleaned dataset to /output directory
```{r}
saveRDS(part6beeped, here("output", "part6beeped.rds"))
```